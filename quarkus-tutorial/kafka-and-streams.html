<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Apache Kafka with Reactive Streams :: Quarkus Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/quarkus-tutorial/quarkus-tutorial/kafka-and-streams.html">
    <link rel="prev" href="reactive.html">
    <link rel="next" href="security.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/quarkus-tutorial">Quarkus Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="quarkus-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html">Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basics</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basics.html">Basics and Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="panache.html">Hibernate with Panache</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="spring.html">Spring Compatibility</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kubernetes.html">Deploy to Kubernetes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cloud Native</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="rest-client.html">REST Client</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="fault-tolerance.html">Fault Tolerance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="health.html">Health Check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="metrics.html">Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reactive.html">Reactive with Mutiny</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="kafka-and-streams.html">Apache Kafka with Reactive Streams</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security.html">Security with JWT RBAC</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">quarkus-tutorial</a></li>
    <li>Cloud Native</li>
    <li><a href="kafka-and-streams.html">Apache Kafka with Reactive Streams</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/dextro67/quarkus-tutorial/edit/master/documentation/modules/ROOT/pages/kafka-and-streams.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Apache Kafka with Reactive Streams</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Mutiny is just part of the Reactive story. To complement it, we need Reactive Streams too. And an important service that can serve as the underlying implementation for our stream is <a href="http://kafka.apache.org" target="_blank" rel="noopener">Apache Kafka</a>.</p>
</div>
<div class="paragraph">
<p>In this chapter we&#8217;re going to use Mutiny to create price request for wines to a remote service called <code>price-generator</code> using Kafka as the broker for our messages in a Kafka topic called <code>wine</code>. The <code>price-generator</code> will get the wine from this topic, add a tag price to it, and send the information back in a Kafka topic called <code>priced-wine</code>. Finally, we&#8217;ll read the priced wines from the topic and send it throught our REST endpoint using SSE (Server-Side Events).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_the_reactive_messaging_kafka_extension"><a class="anchor" href="#_add_the_reactive_messaging_kafka_extension"></a>Add the Reactive Messaging Kafka extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just open a new terminal window, and make sure youâ€™re at the root of your <code>tutorial-app</code> project, then run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextensions="io.quarkus:quarkus-smallrye-reactive-messaging-kafka"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_wine_pojo"><a class="anchor" href="#_create_wine_pojo"></a>Create Wine POJO</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a new <code>Wine</code> Java class in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import java.math.BigDecimal;

public class Wine {

    private String name;

    private Wine(String name) {
        this.name = name;
    }

    public static Wine of(String name) {
        return new Wine(name);
    }

    public PricedWine withPrice(BigDecimal price) {
        return PricedWine.of(this.name, price);
    }

    public String getName() {
        return name;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_pricedwine_pojo"><a class="anchor" href="#_create_pricedwine_pojo"></a>Create PricedWine POJO</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a new <code>PricedWine</code> Java class in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import java.math.BigDecimal;

import javax.json.bind.annotation.JsonbCreator;

public class PricedWine {

    private String name;

    private BigDecimal price;

    private PricedWine(String name, BigDecimal price) {
        this.name = name;
        this.price = price;
    }

    @JsonbCreator
    public static PricedWine of(String name, double price) {
        return new PricedWine(name, new BigDecimal(price).setScale(2));
    }

    public static PricedWine of(String name, BigDecimal price) {
        return new PricedWine(name, price);
    }

    public String getName() {
        return name;
    }

    public BigDecimal getPrice() {
        return price;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_winegenerator"><a class="anchor" href="#_create_winegenerator"></a>Create WineGenerator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a new <code>WineGenerator</code> Java class in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import java.time.Duration;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.ThreadLocalRandom;
import java.util.stream.Collectors;

import javax.enterprise.context.ApplicationScoped;
import javax.json.bind.JsonbBuilder;

import org.eclipse.microprofile.reactive.messaging.Outgoing;

import io.smallrye.mutiny.Multi;

@ApplicationScoped
public class WineGenerator {

    private static final List&lt;Wine&gt; WINES =
        Arrays.asList("Fay", "Cask 23", "Jordan", "Caymus", "Don Melchor", "Barca Velha", "Pera Manca")
            .stream().map(Wine::of).collect(Collectors.toList());

    @Outgoing("wine")
    Multi&lt;String&gt; wines() {
        return Multi.createFrom().ticks().every(Duration.ofSeconds(1)) <i class="conum" data-value="1"></i><b>(1)</b>
        .onOverflow().drop() <i class="conum" data-value="2"></i><b>(2)</b>
        .map(tick -&gt; WINES.get(ThreadLocalRandom.current().nextInt(0, WINES.size()))) <i class="conum" data-value="3"></i><b>(3)</b>
        .map(JsonbBuilder.create()::toJson); <i class="conum" data-value="4"></i><b>(4)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;re creating a Multi that generates a new message every <code>1</code> second.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We apply backpressure by dropping the messages if the topic is not ready.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For each message we choose a random <code>Wine</code> from our list.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We map the <code>Wine</code> to JSON format.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_wineresource"><a class="anchor" href="#_create_wineresource"></a>Create WineResource</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a new <code>WineResource</code> Java class in <code>src/main/java</code> in the <code>com.redhat.developers</code> package with the following contents:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import javax.inject.Inject;
import javax.json.bind.JsonbBuilder;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

import org.eclipse.microprofile.reactive.messaging.Channel;
import org.jboss.resteasy.annotations.SseElementType;

import io.smallrye.mutiny.Multi;

@Path("/wine")
public class WineResource {

    @Channel("priced-wine") <i class="conum" data-value="1"></i><b>(1)</b>
    Multi&lt;String&gt; pricedWines;

    @GET
    @Produces(MediaType.SERVER_SENT_EVENTS)
    @SseElementType(MediaType.APPLICATION_JSON)
    public Multi&lt;PricedWine&gt; wines() {
        return pricedWines.map(s -&gt; JsonbBuilder.create().fromJson(s, PricedWine.class)); <i class="conum" data-value="2"></i><b>(2)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We inject the Multi directly by using the <code>@Channel</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We just map the <code>PricedWine</code> to JSON format.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_the_reactive_messaging_kafka_properties"><a class="anchor" href="#_add_the_reactive_messaging_kafka_properties"></a>Add the Reactive Messaging Kafka properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add the following properties to your <code>application.properties</code> in <code>src/main/resources</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">mp.messaging.incoming.priced-wine.connector=smallrye-kafka
mp.messaging.incoming.priced-wine.topic=priced-wine
mp.messaging.incoming.priced-wine.value.deserializer=org.apache.kafka.common.serialization.StringDeserializer

mp.messaging.outgoing.wine.connector=smallrye-kafka
mp.messaging.outgoing.wine.topic=wine
mp.messaging.outgoing.wine.value.serializer=org.apache.kafka.common.serialization.StringSerializer</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_docker_compose_configuration"><a class="anchor" href="#_create_docker_compose_configuration"></a>Create docker-compose configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The external dependencies required to run this chapter are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka</p>
</li>
<li>
<p>Zookeeper (required by Kafka)</p>
</li>
<li>
<p>The <code>price-generator</code> service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;re going to use <code>docker-compose</code> to bootstrap these external services.</p>
</div>
<div class="paragraph">
<p>Create a new file called <code>docker-compose.yml</code> in the root of your <code>tutorial-app</code> folder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">version: '3'
services:
  zookeeper:
    image: strimzi/kafka:0.11.3-kafka-2.1.0
    command: [
      "sh", "-c",
      "bin/zookeeper-server-start.sh config/zookeeper.properties"
    ]
    ports:
      - "2181:2181"
    environment:
      LOG_DIR: /tmp/logs
  kafka:
    image: strimzi/kafka:0.11.3-kafka-2.1.0
    command: [
      "sh", "-c",
      "bin/kafka-server-start.sh config/server.properties --override listeners=$${KAFKA_LISTENERS} --override advertised.listeners=$${KAFKA_ADVERTISED_LISTENERS} --override zookeeper.connect=$${KAFKA_ZOOKEEPER_CONNECT}"
    ]
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      LOG_DIR: "/tmp/logs"
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  price-generator:
    image: quay.io/rhdevelopers/quarkus-tutorial-price-generator:1.0
    network_mode: host
    depends_on:
      - kafka</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_docker_compose"><a class="anchor" href="#_run_docker_compose"></a>Run docker-compose</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure you are in the same folder that you&#8217;ve created the <code>docker-compose.yml</code> file (in our case, the root of our <code>tutorial-app</code> folder).</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker-compose up</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">kafka_1            | [2020-05-13 01:54:53,281] INFO [ThrottledChannelReaper-Fetch]: Starting (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
kafka_1            | [2020-05-13 01:54:53,281] INFO [ThrottledChannelReaper-Produce]: Starting (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
kafka_1            | [2020-05-13 01:54:53,284] INFO [ThrottledChannelReaper-Request]: Starting (kafka.server.ClientQuotaManager$ThrottledChannelReaper)
kafka_1            | [2020-05-13 01:54:53,367] INFO Loading logs. (kafka.log.LogManager)
kafka_1            | [2020-05-13 01:54:53,504] INFO [Log partition=__consumer_offsets-38, dir=/tmp/kafka-logs] Loading producer state till offset 15 with message format version 2 (kafka.log.Log)
kafka_1            | [2020-05-13 01:54:53,531] INFO [ProducerStateManager partition=__consumer_offsets-38] Loading producer state from snapshot file '/tmp/kafka-logs/__consumer_offsets-38/00000000000000000015.snapshot' (kafka.log.ProducerStateManager)
kafka_1            | [2020-05-13 01:54:53,550] INFO [Log partition=__consumer_offsets-38, dir=/tmp/kafka-logs] Completed load of log with 1 segments, log start offset 0 and log end offset 15 in 125 ms (kafka.log.Log)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_invoke_the_wine_endpoint"><a class="anchor" href="#_invoke_the_wine_endpoint"></a>Invoke the /wine endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -N localhost:8080/wine</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">data: {"name":"Don Melchor","price":1921.00}

data: {"name":"Jordan","price":546.00}

data: {"name":"Cask 23","price":1089.00}

data: {"name":"Barca Velha","price":1855.00}

data: {"name":"Don Melchor","price":272.00}

data: {"name":"Cask 23","price":1500.00}

data: {"name":"Caymus","price":275.00}

data: {"name":"Cask 23","price":1084.00}

data: {"name":"Fay","price":1547.00}

data: {"name":"Jordan","price":917.00}

data: {"name":"Jordan","price":1090.00}

data: {"name":"Jordan","price":235.00}

data: {"name":"Don Melchor","price":1468.00}

data: {"name":"Pera Manca","price":1534.00}

data: {"name":"Barca Velha","price":316.00}</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="reactive.html">Reactive with Mutiny</a></span>
  <span class="next"><a href="security.html">Security with JWT RBAC</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
